# Agent 监控与告警方案

## 1. 监控目标

实时掌握 Agent 运行状态，及时发现异常行为和安全威胁。

---

## 2. 监控维度

### 2.1 系统层监控

| 监控项 | 指标 | 阈值 | 告警级别 |
|--------|------|------|----------|
| CPU使用率 | % | > 80% | WARNING |
| 内存使用率 | % | > 85% | WARNING |
| 磁盘使用率 | % | > 90% | CRITICAL |
| Gateway延迟 | ms | > 5000 | WARNING |
| API调用失败率 | % | > 5% | CRITICAL |

### 2.2 会话层监控

| 监控项 | 指标 | 阈值 | 告警级别 |
|--------|------|------|----------|
| 会话长度 | 消息数 | > 500 | INFO |
| 响应延迟 | 秒 | > 120 | WARNING |
| Token消耗 | 数量/分钟 | > 10000 | WARNING |
| 上下文溢出 | 次数 | > 0 | WARNING |

### 2.3 安全层监控

| 监控项 | 指标 | 阈值 | 告警级别 |
|--------|------|------|----------|
| 敏感词拦截 | 次数/分钟 | > 5 | WARNING |
| Prompt完整性失败 | 次数 | > 0 | CRITICAL |
| 异常行为检测 | 次数/小时 | > 3 | WARNING |
| 恢复触发 | 次数/天 | > 5 | CRITICAL |

### 2.4 模型层监控

| 监控项 | 指标 | 阈值 | 告警级别 |
|--------|------|------|----------|
| 模型错误率 | % | > 10% | WARNING |
| 响应质量分 | 评分 | < 0.5 | WARNING |

---

## 3. 告警机制

### 3.1 告警级别

| 级别 | 标识 | 处理时限 | 通知方式 |
|------|------|----------|----------|
| CRITICAL | 🔴 | 立即 | 电话 + 短信 + 邮件 |
| WARNING | 🟡 | 30分钟 | 邮件 + 推送 |
| INFO | 🔵 | 无需 | 仅日志 |

### 3.2 告警通道

- **邮件告警**：SMTP配置
- **短信告警**：短信服务商API
- **Telegram告警**：Bot API
- **Webhook告警**：自定义回调

### 3.3 告警规则示例

```python
ALERT_RULES = [
    {"name": "敏感词拦截频繁", "condition": lambda ctx: ctx.get("blocked", 0) > 5, "level": "WARNING"},
    {"name": "Prompt被篡改", "condition": lambda ctx: ctx.get("integrity_failed", False), "level": "CRITICAL"},
    {"name": "响应延迟过高", "condition": lambda ctx: ctx.get("latency", 0) > 120, "level": "WARNING"},
]
```

---

## 4. 仪表盘设计

### 4.1 核心指标

- 会话数、活跃用户、Token消耗
- 响应延迟趋势
- 安全告警数量、模型错误率

### 4.2 安全事件时间线

按时间展示最近24小时的安全事件，包含级别、描述、处理状态。

---

## 5. 日志管理

### 5.1 日志级别

DEBUG → INFO → WARNING → ERROR → CRITICAL

### 5.2 日志格式

JSON格式，包含timestamp、level、source、session_id、action、details等字段。

### 5.3 存储策略

- **控制台**：INFO级别
- **应用日志**：DEBUG级别，保留5天
- **安全日志**：WARNING级别，保留90天
- **指标日志**：INFO级别，保留30天

---

## 6. 报告生成

### 6.1 定期报告

| 类型 | 频率 | 接收人 |
|------|------|--------|
| 日报 | 每天 | 运维 |
| 周报 | 每周 | 运维+产品 |
| 月报 | 每月 | 管理层 |

### 6.2 报告内容

- 概览（活跃会话、消息数、Token消耗）
- 性能指标（延迟、错误率、可用性）
- 安全事件统计
- 告警统计
- 问题与建议

---

*文档版本：1.0*
*最后更新：2026-02-28*
